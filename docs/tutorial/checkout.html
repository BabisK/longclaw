<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Configuring Payment · Longclaw</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;p&gt;Longclaw offers integration with a few payment gateways and it is also fairly easy to integrate your own.&lt;/p&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Configuring Payment · Longclaw"/><meta property="og:type" content="website"/><meta property="og:url" content="https://JamesRamm.github.io/longclaw/index.html"/><meta property="og:description" content="&lt;p&gt;Longclaw offers integration with a few payment gateways and it is also fairly easy to integrate your own.&lt;/p&gt;
"/><meta property="og:image" content="https://JamesRamm.github.io/longclaw/img/shop.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://JamesRamm.github.io/longclaw/img/shop.png"/><link rel="shortcut icon" href="/longclaw/img/favicon/favicon.ico"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/longclaw/css/main.css"/></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/longclaw/"><img class="logo" src="/longclaw/img/shop.png" alt="Longclaw"/><h2 class="headerTitleWithLogo">Longclaw</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/longclaw/docs/tutorial/introduction" target="_self">Docs</a></li><li class=""><a href="http://.google.com" target="_self">Demo</a></li><li class=""><a href="/longclaw/help" target="_self">Help</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><i></i></div><h2><i>›</i><span>Tutorial</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Tutorial</h3><ul><li class="navListItem"><a class="navItem" href="/longclaw/docs/tutorial/introduction">Introduction</a></li><li class="navListItem"><a class="navItem" href="/longclaw/docs/tutorial/install">Setup</a></li><li class="navListItem"><a class="navItem" href="/longclaw/docs/tutorial/products">Adding Products</a></li><li class="navListItem"><a class="navItem" href="/longclaw/docs/tutorial/shipping">Shipping</a></li><li class="navListItem"><a class="navItem" href="/longclaw/docs/tutorial/frontend">Frontend</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/longclaw/docs/tutorial/checkout">Payment</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">User Guide</h3><ul><li class="navListItem"><a class="navItem" href="/longclaw/docs/guide/checkout">Checkout</a></li><li class="navListItem"><a class="navItem" href="/longclaw/docs/guide/payments">Integrations</a></li><li class="navListItem"><a class="navItem" href="/longclaw/docs/guide/basket">Basket</a></li><li class="navListItem"><a class="navItem" href="/longclaw/docs/guide/api">API Client</a></li><li class="navListItem"><a class="navItem" href="/longclaw/docs/guide/checkout_api">Checkout API</a></li><li class="navListItem"><a class="navItem" href="/longclaw/docs/guide/contrib">Product Requests</a></li></ul></div></div></section></div><script>
            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              const headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                if (event.target.tagName === 'A') {
                  document.body.classList.remove('tocActive');
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Configuring Payment</h1></header><article><div><span><p>Longclaw offers integration with a few payment gateways and it is also fairly easy to integrate your own.
For this tutorial, we will use Braintree to process payments.</p>
<h2><a class="anchor" aria-hidden="true" id="settings-and-dependencies"></a><a href="#settings-and-dependencies" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Settings and Dependencies</h2>
<p>The payment gateway to use must be set in the settings file:</p>
<pre><code class="hljs css language-python">PAYMENT_GATEWAY = <span class="hljs-string">'longclaw.checkout.gateways.braintree.BraintreePayment'</span>
</code></pre>
<p>We also need to define settings for access tokens;</p>
<pre><code class="hljs css language-python">    BRAINTREE_SANDBOX = <span class="hljs-keyword">False</span>
    BRAINTREE_MERCHANT_ID = os.environ[<span class="hljs-string">'BRAINTREE_MERCHANT_ID'</span>]
    BRAINTREE_PUBLIC_KEY = os.environ[<span class="hljs-string">'BRAINTREE_PUBLIC_KEY'</span>]
    BRAINTREE_PRIVATE_KEY = os.environ[<span class="hljs-string">'BRAINTREE_PRIVATE_KEY'</span>]
</code></pre>
<p>We will need to install this SDK as it is not an explicit dependency of longclaw:</p>
<pre><code class="hljs css language-bash">pip install braintree
</code></pre>
<p>That is all we need to do to configure our backend!</p>
<h2><a class="anchor" aria-hidden="true" id="front-end-integration"></a><a href="#front-end-integration" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Front end integration</h2>
<p>We will first show how to setup a checkout page using the Checkout view provided by longclaw.
The code shown here is very similar to the implementation of the checkout page here: <a href="https://github.com/JamesRamm/ramshacklerecording">Ramshackle Audio</a></p>
<p>First, we should load some templatetags which will help us:</p>
<pre><code class="hljs css language-django"><span class="xml"></span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">load</span></span> longclawcheckout_tags longclawcore_tags %}</span><span class="xml">
</span></code></pre>
<p>As an aside - you may wish to display the items in the basket on our checkout page. The basket items queryset is available as <code>basket</code>
in the views' context.</p>
<p>Next, we need to setup the forms to gather customer information. There are 2 forms in the context. We will
display and submit them as a single form. Here is an example layout:</p>
<pre><code class="hljs css language-django"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"."</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"checkout-form"</span>&gt;</span>
    </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">csrf_token</span></span> %}</span><span class="xml">
    </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">for</span></span> field <span class="hljs-keyword">in</span> shipping_form %}</span><span class="xml">
        </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">if</span></span> field.is_hidden %}</span><span class="xml">
        </span><span class="hljs-template-variable">{{ field }}</span><span class="xml">
        </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">else</span></span> %}</span><span class="xml">
        </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">if</span></span> field.errors %}</span><span class="xml">
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"field error"</span>&gt;</span>
        </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">else</span></span> %}</span><span class="xml">
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"field"</span>&gt;</span>
        </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endif</span></span> %}</span><span class="xml">
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><span class="hljs-template-variable">{{ field.label_tag }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            </span><span class="hljs-template-variable">{{ field }}</span><span class="xml">
            </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">if</span></span> field.help_text %}</span><span class="xml">
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"help"</span>&gt;</span></span><span class="hljs-template-variable">{{ field.help_text|<span class="hljs-name">safe</span> }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endif</span></span> %}</span><span class="xml">
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ui error message"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><span class="hljs-template-variable">{{ field.errors }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endif</span></span> %}</span><span class="xml">
    </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endfor</span></span> %}</span><span class="xml">
    </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">for</span></span> field <span class="hljs-keyword">in</span> checkout_form %}</span><span class="xml">
    <span class="hljs-comment">&lt;!-- purposefully ignoring different billing address option to simplify --&gt;</span>
    </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">if</span></span> field.name == 'different_billing_address' %}</span><span class="xml">
    </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">else</span></span> %}</span><span class="xml">
    </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">if</span></span> field.errors %}</span><span class="xml">
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"field error"</span>&gt;</span>
    </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">else</span></span> %}</span><span class="xml">
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"field"</span>&gt;</span>
    </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endif</span></span> %}</span><span class="xml">
        <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span></span><span class="hljs-template-variable">{{ field.label_tag }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
        </span><span class="hljs-template-variable">{{ field }}</span><span class="xml">
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ui error message"</span>&gt;</span>
            </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">for</span></span> error <span class="hljs-keyword">in</span> field.errors %}</span><span class="xml">
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><span class="hljs-template-variable">{{ error }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endfor</span></span> %}</span><span class="xml">
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endif</span></span> %}</span><span class="xml">
    </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endfor</span></span> %}</span><span class="xml">
</span></code></pre>
<p>You may wish to layout the form differently. We have purposefully ignored the <code>different_billing_address</code> field
since the Braintree dropin-ui will collect a billing postcode anyway, for its' own security checks.</p>
<p>Before we close our <code>&lt;form&gt;</code> element, there are 3 further items to add:</p>
<pre><code class="hljs css language-django"><span class="xml">    <span class="hljs-comment">&lt;!-- hidden field for submitting the token back to the server. Name will vary depending on integration--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"payment_method_nonce"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"payment_method_nonce"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">input</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h4</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ui dividing header"</span>&gt;</span>Payment Details<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dropin-container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"submit-button"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"Place Order"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ui button submit"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
</span></code></pre>
<p>We add a hidden field. This field will contain a token (string of characters) given by braintree which represents the payment method.
Most payment gateways require something like this, although the name of the field will change between backends.</p>
<p>We then add an empty div with the id <code>dropin-container</code>. This will contain the Braintree Dropin UI.
We could manually create the fields (using e.g. Hosted Fields for braintree or Elements for stripe) for payment forms, however
most integrations offer some sort of 'dropin' which are increasingly customisable. For most purposes, this will suffice.</p>
<p>Finally, we add a submit button.</p>
<h3><a class="anchor" aria-hidden="true" id="the-javascript"></a><a href="#the-javascript" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The Javascript</h3>
<p>OK, so now we have hidden elements, empty containers....we need to get this stuff populated!
Each payment gateway integration provides the necessary javascript libraries to interact with the gateway.
They are made available via a template tag.
Add them like this:</p>
<pre><code class="hljs css language-django"><span class="xml">    <span class="hljs-comment">&lt;!--Load any client javascript provided by the payment gateway.
    I have chosen braintree as my gateway so the template tag below
    should give me a list of script tags which load the braintree
    SDK's
    --&gt;</span>
    </span><span class="hljs-template-tag">{% <span class="hljs-name">gateway_client_js</span> <span class="hljs-keyword">as</span> scripts %}</span><span class="xml">
    </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">for</span></span> js <span class="hljs-keyword">in</span> scripts %}</span><span class="xml">
        </span><span class="hljs-template-variable">{{ js|<span class="hljs-name">safe</span> }}</span><span class="xml">
    </span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endfor</span></span> %}</span><span class="xml">

    <span class="hljs-comment">&lt;!--Finally add the media from the checkout form.--&gt;</span>
    </span><span class="hljs-template-variable">{{ checkout_form.media }}</span><span class="xml">
</span></code></pre>
<p>The checkout form also provides a little javascript to initialise shipping options (when the user selects a shipping country).</p>
<p>Finally, we need to add a little of our own javascript to create the braintree dropin:</p>
<pre><code class="hljs css language-django"><span class="xml">    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span>&gt;</span><span class="actionscript">

        <span class="hljs-comment">//Initialize shipping options - this function is from the</span>
        <span class="hljs-comment">//checkout form media.</span>
        initShippingOption(<span class="hljs-string">'</span></span></span><span class="hljs-template-tag">{% <span class="hljs-name">longclaw_api_url_prefix</span> %}</span><span class="xml"><span class="undefined">');

        // Initialize the braintree dropin.
        // The gateway token below is taken from the template tag provided by
        // longclaw. This is calculated depending on the chosen
        // PAYMENT_GATEWAY in the user settings.py
        var button = document.querySelector('#submit-button');

        braintree.dropin.create({
            authorization: "</span></span><span class="hljs-template-tag">{% <span class="hljs-name">gateway_token</span> %}</span><span class="xml"><span class="undefined">",
            container: '#dropin-container'
        }, function (createErr, instance) {
            button.addEventListener('click', function (event) {
            event.preventDefault();
            if (instance){
                instance.requestPaymentMethod(function (err, payload) {
                    // Submit payload.nonce to your server
                    if (err) {
                        // TODO: Handle this error
                        console.log(err);
                    }
                    else {
                        $('#payment_method_nonce').val(payload.nonce);
                        document.getElementById("checkout-form").submit();
                    }
                });
            }
            });
        });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</span></code></pre>
<p>Two things are happening in the above code. First, we initialise the shipping options. Note we are using a template tag
to pass the longclaw API url prefix, since this is customisable in your settings.py</p>
<p>Secondly, we initialise the braintree dropin. Again, we use a template tag to get a token for the gateway.
All payment backends provide the <code>gateway_token</code> template tag, although it is not always necessary.</p>
<p>You may wish to only show the braintree payment form if the user has anything in their basket. In which case you might qualify
the above javascript with <code>{% if basket.count &gt; 0 %}</code> in your template.</p>
<p>As you can see, setting up the checkout is one of the most involved aspects of creating your store. We have worked to simplify this
for v0.2, but welcome any suggestions on how to make it easier!</p>
<p>If you wish to forego the templatetags &amp; forms (e.g. if making a fully React-based frontend), read on. Otherwise, that is the end of the tutorial!</p>
<h2><a class="anchor" aria-hidden="true" id="javascript-only-integration"></a><a href="#javascript-only-integration" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Javascript-Only integration</h2>
<p>Below is a walkthrough of integrating a payment gateway (PayPal) without the aid of templatetags etc..</p>
<p>There is a fair amount of work to do to setup the front end when using any payment gateway. Paypal
Express minimises this for us by taking charge of collecting and tokenizing payment data, although we
must still configure it.</p>
<p>The basic client payment flow with Braintree is as follows:</p>
<ol>
<li>The client requests a braintree token. Longclaw provides an API endpoint to generate tokens using the braintree SDK</li>
<li>The client gathers payment details and turns this into a <code>payment method nonce</code> by interacting with the braintree server.
Paypal Express Checkout will take care of this entirely.</li>
<li>The client submits the <code>payment method nonce</code> to the server to capture the payment. Longclaw provides an API endpoint for all payment captures.</li>
</ol>
<p>We therefore have three things we need to do in our client-side javascript:</p>
<ol>
<li>Call the longclaw API to generate a token</li>
</ol>
<pre><code class="hljs css language-javascript">$.get({
<span class="hljs-attr">url</span>: <span class="hljs-string">'api/checkout/token/'</span>,
<span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>)</span>{
    ...
}
})
</code></pre>
<ol>
<li>Following this, configure the paypal express checkout functionality. This actually has two steps.
We must first create a braintree <code>client</code> using our new token. We then use this to create a braintree
<code>paypal</code> instance.</li>
</ol>
<pre><code class="hljs css language-javascript">    braintree.client.create({
            <span class="hljs-attr">authorization</span>: token
        }, (err, client) =&gt; {
            <span class="hljs-keyword">if</span> (err) {
              <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"handle error creating client"</span>);
              <span class="hljs-keyword">return</span>;
            };
            braintree.paypal.create({
                <span class="hljs-attr">client</span>: client
            }, (err, paypalInstance) =&gt; {
                <span class="hljs-keyword">if</span> (err) {
                  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"handle error creating paypal"</span>);
                  <span class="hljs-keyword">return</span>;
                }
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Paypal instance"</span>: paypalInstance);
            });
        });
</code></pre>
<ol>
<li>Once paypal has created the <code>nonce</code> for the entered payment details, we must submit this
to our server so longclaw can capture the payment.
To do this, we must have a button which we want to use to launch the paypal express checkout window.
We 'attach' the paypal instance we just created to the button like so:</li>
</ol>
<pre><code class="hljs css language-javascript">    paypalButton.addEventListener(
      <span class="hljs-string">'click'</span>,
      <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>)</span>{
          paypalInstance.tokenize({
              <span class="hljs-attr">flow</span>: <span class="hljs-string">'checkout'</span>,
              <span class="hljs-attr">intent</span>: <span class="hljs-string">'sale'</span>,
              <span class="hljs-attr">amount</span>: totalAmount,
              <span class="hljs-attr">currency</span>: currency,
              <span class="hljs-attr">displayName</span>: <span class="hljs-string">'Ramshackle Audio'</span>,
              <span class="hljs-attr">enableShippingAddress</span>: enableShippingAddress,
              <span class="hljs-attr">shippingAddressEditable</span>: shippingAddressEditable
          }, (err, tokenPayload) =&gt; {
              <span class="hljs-keyword">if</span> (!err) {
                  handleSubmit(tokenPayload);
              }
              <span class="hljs-keyword">else</span> {
                  <span class="hljs-built_in">console</span>.log(err)
              }
          });
      });
</code></pre>
<p>In this example <code>paypalButton</code> is a DOM node referring to the button element we wish to attach paypal to and <code>handleSubmit</code>
is a function which will actually POST the payload to the longclaw api endpoint (<code>api/checkout/</code>)</p>
<p>We can make all these nested API calls simpler if we use ES6 Promises and the fetch API:</p>
<pre><code class="hljs css language-javascript">    <span class="hljs-comment">// Wrap braintree js functions as promises</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">braintreeClientCreate</span>(<span class="hljs-params">token</span>)</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>)</span>{
            braintree.client.create({
                <span class="hljs-attr">authorization</span>: token
            }, (err, data) =&gt; {
                <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> reject(err);
                resolve(data);
            });
        });
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">braintreePaypalCreate</span>(<span class="hljs-params">client</span>)</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>)</span>{
            braintree.paypal.create({
                <span class="hljs-attr">client</span>: client
            }, (err, data) =&gt; {
                <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> reject(err);
                resolve(data);
            });
        });
    }

    <span class="hljs-comment">// functions for tokenizing and calling the longclaw checkout</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getToken</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> fetch(
        <span class="hljs-string">'/api/checkout/token/'</span>,
        {
          <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
          <span class="hljs-attr">headers</span>: getRequestHeaders(),
          <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>    }
      )
        .then(checkStatus)
        .then(parseJSON);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkout</span>(<span class="hljs-params">data</span>) </span>{
      <span class="hljs-keyword">return</span> fetch(
        <span class="hljs-string">'/api/checkout/'</span>,
        {
          <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
          <span class="hljs-attr">headers</span>: getRequestHeaders(isForm),
          <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>,
          <span class="hljs-attr">body</span>: <span class="hljs-built_in">JSON</span>.stringify(data)
        }
      )
        .then(checkStatus)
        .then(parseJSON);
    }

    <span class="hljs-comment">// This is where we actually setup paypal</span>
    <span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupBraintreePaypal</span>(<span class="hljs-params">totalAmount,
                                        paypalButton,
                                        shippingAddress,
                                        shippingRate,
                                        email,
                                        currency=<span class="hljs-string">'GBP'</span>,
                                        enableShippingAddress=false,
                                        shippingAddressEditable=false</span>)</span>{

      <span class="hljs-keyword">return</span> getToken()
          .then(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> braintreeClientCreate(data.token))
          .then(<span class="hljs-function"><span class="hljs-params">client</span> =&gt;</span> braintreePaypalCreate(client))
          .then(<span class="hljs-function"><span class="hljs-params">paypalInstance</span> =&gt;</span> paypalButton.addEventListener(<span class="hljs-string">'click'</span>,
              <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>)</span>{
                  paypalInstance.tokenize({
                      <span class="hljs-attr">flow</span>: <span class="hljs-string">'checkout'</span>,
                      <span class="hljs-attr">intent</span>: <span class="hljs-string">'sale'</span>,
                      <span class="hljs-attr">amount</span>: totalAmount,
                      <span class="hljs-attr">currency</span>: currency,
                      <span class="hljs-attr">displayName</span>: <span class="hljs-string">'Ramshackle Audio'</span>,
                      <span class="hljs-attr">enableShippingAddress</span>: enableShippingAddress,
                      <span class="hljs-attr">shippingAddressEditable</span>: shippingAddressEditable
                  }, (err, tokenPayload) =&gt; {
                      <span class="hljs-keyword">if</span> (!err) {
                          <span class="hljs-keyword">return</span> checkout({
                            <span class="hljs-attr">address</span>: shippingAddress
                            shipping_rate: shippingRate,
                            <span class="hljs-attr">email</span>: email,
                            <span class="hljs-attr">payment_method_nonce</span>: tokenPayload.nonce
                          });
                      }
                      <span class="hljs-keyword">else</span> {
                          <span class="hljs-built_in">console</span>.log(err)
                      }
                  });
              })
          )
        }
    }

    <span class="hljs-comment">// helper functions for making requests</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRequestHeaders</span>(<span class="hljs-params">form = false</span>) </span>{
      <span class="hljs-keyword">let</span> contentType = <span class="hljs-string">'application/json'</span>;
      <span class="hljs-keyword">const</span> headers = {
        <span class="hljs-attr">Accept</span>: <span class="hljs-string">'application/json, application/json, application/coreapi+json'</span>,

      };
      <span class="hljs-keyword">if</span> (!form) headers[<span class="hljs-string">'Content-Type'</span>] = contentType;
      <span class="hljs-keyword">const</span> csrf = JsCookie.get(<span class="hljs-string">'csrftoken'</span>);
      <span class="hljs-keyword">if</span> (csrf) headers[<span class="hljs-string">'X-CSRFToken'</span>] = csrf;
      <span class="hljs-keyword">return</span> headers;
    }

    <span class="hljs-comment">/**
    * Check the response status and raise an error if it's no good.
    * @param {object} response - the http response object as provided by fetch
    * @returns {object} - the http rsponse object or throws an error
    */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkStatus</span>(<span class="hljs-params">response</span>) </span>{
      <span class="hljs-keyword">if</span> (response.ok) {
        <span class="hljs-keyword">return</span> response;
      }
      <span class="hljs-keyword">return</span> response.json().then(<span class="hljs-function"><span class="hljs-params">json</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> error = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(response.statusText)
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">Object</span>.assign(error, { response, json })
      })
    }

    <span class="hljs-comment">/**
    * Return an object given an http json response
    * @param {object} response - json encoded response object as provided by fetch
    * @returns {object} - The parsed json
    */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseJSON</span>(<span class="hljs-params">response</span>) </span>{
      <span class="hljs-keyword">return</span> response.json();
    }
</code></pre>
<p>The total amount, shipping address, shipping rate and email address of the customer are passed into the setup function;
it is up to the front end developer to create the necessary forms to gather these.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/longclaw/docs/tutorial/frontend"><span class="arrow-prev">← </span><span>Frontend</span></a><a class="docs-next button" href="/longclaw/docs/guide/checkout"><span>Checkout</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#settings-and-dependencies">Settings and Dependencies</a></li><li><a href="#front-end-integration">Front end integration</a><ul class="toc-headings"><li><a href="#the-javascript">The Javascript</a></li></ul></li><li><a href="#javascript-only-integration">Javascript-Only integration</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/longclaw/" class="nav-home"><img src="/longclaw/img/shop.png" alt="Longclaw" width="66" height="58"/></a><div><h5>Docs</h5><a href="/longclaw/docs/en/tutorial/introduction.html">Getting Started (or other categories)</a><a href="/longclaw/docs/en/doc2.html">Guides (or other categories)</a><a href="/longclaw/docs/en/doc3.html">API Reference (or other categories)</a></div><div><h5>Community</h5><a href="/longclaw/en/users.html">User Showcase</a><a href="http://stackoverflow.com/questions/tagged/" target="_blank" rel="noreferrer noopener">Stack Overflow</a><a href="https://discordapp.com/">Project Chat</a></div><div><h5>More</h5><a href="/longclaw/blog">Blog</a><a href="https://github.com/JamesRamm/longclaw">GitHub</a><a class="github-button" href="https://github.com/JamesRamm/longclaw" data-icon="octicon-star" data-count-href="/facebook/docusaurus/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section><section class="copyright">Copyright © 2018 James Ramm</section></footer></div></body></html>